<?php

/**
 * Implements hook_menu().
 */
function commerce_postfinance_menu() {
  $items = array();

  // Define an always accessible path to receive IPNs.
  $items['commerce_postfinance/IPN/%state'] = array(
    'page callback' => 'commerce_postfinance_process_ipn',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );


  return $items;
}


/**
 * Payment method callback: settings form.
 */
function commerce_postfinance_settings_form($settings = NULL) {
  $form = array();

  // Merge default settings into the stored settings array.
  $default_currency = variable_get('commerce_default_currency', 'CHF');

  $settings = (array) $settings + array(
    'PSPID' => '',
    'currency_code' => in_array($default_currency, array_keys(commerce_postfinance_default_currencies())) ? $default_currency : 'CHF',
    'language' => 'DE',
    'server' => 'test',
    'server_encoding' => 'iso',
    'payment_security' => 'none',
    'payment_security_key' => '',
    'reply_security_key' => '',
    'order_prefix' => '',
  );

  $form['PSPID'] = array(
    '#type' => 'textfield',
    '#title' => t('PSPID'),
    '#description' => t('The PSPID you use for the Postfinance ePayment account you want to receive payments.'),
    '#default_value' => $settings['PSPID'],
    '#required' => TRUE,
  );
  $form['currency_code'] = array(
    '#type' => 'select',
    '#title' => t('Currency code'),
    '#description' => t('Transactions can only be processed in one of the listed currencies.'),
    '#options' => commerce_postfinance_default_currencies(),
    '#default_value' => $settings['currency_code'],
  );
  $form['language'] = array(
    '#type' => 'select',
    '#title' => t('Language submitted to Postfinance ePayment'),
    '#options' => commerce_postfinance_default_languages(),
    '#default_value' => $settings['language'],
  );
  $form['server'] = array(
    '#type' => 'radios',
    '#title' => t('Postfinance server'),
    '#options' => array(
      'test' => ('Test'),
      'prod' => ('Production'),
    ),
    '#default_value' => $settings['server'],
  );
  $form['server_encoding'] = array(
    '#type' => 'radios',
    '#title' => t('The encoding you entered in the Postfinance ePayment configuration'),
    '#options' => array(
      'iso' => ('ISO-8859-1'),
      'utf' => ('UTF-8'),
    ),
    '#default_value' => $settings['server_encoding'],
  );
  $form['payment_security'] = array(
    '#type' => 'radios',
    '#title' => t('Payment Security (SHA-IN and SHA-OUT)'),
    '#options' => array(
      'none' => t('none'),
      'sha1' => t('SHA-1'),
      'sha256' => t('SHA-256'),
      'sha512' => t('SHA-512'),
    ),
    '#default_value' => $settings['payment_security'],
  );
  $form['payment_security_key'] = array(
    '#type' => 'textfield',
    '#title' => t('SHA-X-IN Key'),
    '#description' => t('The Key you entered in the Postfinance ePayment configuration'),
    '#default_value' => $settings['payment_security_key']
  );
  $form['reply_security_key'] = array(
    '#type' => 'textfield',
    '#title' => t('SHA-X-OUT Key'),
    '#description' => t('The Key you entered in the Postfinance ePayment configuration'),
    '#default_value' => $settings['reply_security_key']
  );
  $form['order_prefix'] = array(
    '#type' => 'textfield',
    '#title' => t('Orderprefix'),
    '#description' => t('This will be placed in front of the order number submitted to Postfinance ePayment.'),
    '#default_value' => $settings['order_prefix']
  );
  return $form;
}

/**
 * Implements hook_commerce_payment_method_info().
 */
function commerce_postfinance_commerce_payment_method_info() {
  $payment_methods = array();

  $payment_methods['epayment_postfinance'] = array(
    'base' => 'commerce_postfinance',
    'title' => t('Postfinance e-Payment'),
    'short_title' => t('ePayment'),
    'description' => t('Postfiance ePayment'),
    'terminal' => FALSE,
    'offsite' => TRUE,
  );

  return $payment_methods;
}

/**
 * Payment method callback: redirect form, a wrapper around the module's general
 *   use function for building a WPS form.
 */
function commerce_postfinance_redirect_form($form, &$form_state, $order, $payment_method) {
  // Return an error if the enabling action's settings haven't been configured.
  if (empty($payment_method['settings']['PSPID'])) {
    drupal_set_message(t('Postfinance e-Payment is not configured for use. No PSPID has been specified.'), 'error');
    return array();
  }

  $settings = array(
    // Return to the previous page when payment is canceled
    'cancel_return' => url('checkout/' . $order->order_id . '/payment/back/' . $order->data['payment_redirect_key'], array('absolute' => TRUE)),

    // Return to the payment redirect page for processing successful payments
    'return' => url('checkout/' . $order->order_id . '/payment/return/' . $order->data['payment_redirect_key'], array('absolute' => TRUE)),

    // Specify the current payment method instance ID in the notify_url
    'payment_method' => $payment_method['instance_id'],
  );

  return commerce_postfinance_order_form($form, $form_state, $order, $payment_method['settings'] + $settings);
}

/**
 * Payment method callback: redirect form return validation.
 */
function commerce_postfinance_redirect_form_validate($order, $payment_method) {
  // TODO: Actually do what we can based on the POST information to validate
  // this was a successful payment (although actual transaction completion will
  // depend on the IPN).

  return TRUE;
}

/**
 * Builds a Website Payments Standard form from an order object.
 *
 * @param $order
 *   The fully loaded order being paid for.
 * @param $settings
 *   An array of settings used to build out the form, including:
 *   - server: which server to use, either sandbox or live
 *   - PSPID: the PayPal e-mail address the payment submits to
 *   - cancel_return: the URL PayPal should send the user to on cancellation
 *   - return: the URL PayPal should send the user to on successful payment
 *   - currency_code: the PayPal currency code to use for this payment if the
 *     total for the order is in a non-PayPal supported currency
 *   - language: the PayPal language code to use on the payment form
 *   - payment_action: the PayPal payment action to use: sale, authorization,
 *     or order
 *   - payment_method: optionally the name of the Commerce payment method to
 *     include in the IPN notify_url
 *
 * @return
 *   A renderable form array.
 */
function commerce_postfinance_order_form($form, &$form_state, $order, $settings) {
  $wrapper = entity_metadata_wrapper('commerce_order', $order);

  $total = commerce_line_items_total($wrapper->commerce_line_items, 'product');
  $profile = commerce_customer_profile_load( $order->commerce_customer_billing['und']['0']['profile_id'] );


// Build the data array that will be translated into hidden form values.
  $data = array(


    // The store's PayPal e-mail address
    'PSPID' => $settings['PSPID'],

    // Use the timestamp to generate a unique invoice number
    'orderID' => $settings['order_prefix'].$order->order_number, /* . ' - ' . time(),*/

    // Set the currency and language codes
    'currency' => in_array($total['currency_code'], array_keys(commerce_postfinance_default_currencies())) ? $total['currency_code'] : $settings['currency_code'],
    'language' => $settings['language'],

    // Define a single item in the cart representing the whole order
    'amount' => $total['amount'].'00',
     'tp' => 'http://postfinance.alufelgenboerse.ch/TemplatePage.html',

    'COM' => t('Bestellung @order_number auf @store', array('@order_number' => $order->order_number, '@store' => variable_get('site_name', url('<front>', array('absolute' => TRUE))))),
    'CN' => $profile->commerce_customer_address['und']['0']['name_line'],
    'owneraddress' => commerce_postfinance_buildadress($profile->commerce_customer_address['und']['0']),
    'ownerZIP' => $profile->commerce_customer_address['und']['0']['postal_code'],
    'ownertown' => $profile->commerce_customer_address['und']['0']['locality'],
    'ownercty' => $profile->commerce_customer_address['und']['0']['country'],
    'email' => $order->mail,


    'homeurl' => 'http://www.alufelgenboerse.ch',
    'accepturl' => $settings['return'],
    'backurl' => 'http://www.alufelgenboerse.ch/BACK',
    'cancelurl' => $settings['cancel_return'],
    'declineurl' => 'http://www.alufelgenboerse.ch/DECLINED',
    'catalogurl' => 'http://a.flashag.ch/shop',
    
  );

  $form['#action'] = commerce_postfinance_server_url($settings['server'], $settings['server_encoding']);

// order alphabetically as specified -- they also need to be in order in the form ...
$data = array_flip($data);
natcasesort($data);
$data = array_flip($data);

  foreach ($data as $name => $value) {
    if (!empty($value)) {
      $form[$name] = array('#type' => 'hidden', '#value' => $value);
    }
  }

$shaKey = $settings['payment_security_key'];
if(commerce_postfinance_security($shaKey,$settings['payment_security'])){
  $form['SHASign'] = array('#type' => 'hidden', '#value' => commerce_postfinance_shaDigest($data,$settings,'OUT'));
}

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Bezahlen'),
  );

/*header("Referer: http://alu.flashag.ch/");*/

  return $form;
}

/**
 * Processes an incoming IPN.
 *
 * @param $payment_method
 *   The payment method instance array that originally made the payment.
 * @param $debug_ipn
 *   Optionally specify an IPN array for debug purposes; if left empty, the IPN
 *     be pulled from the $_POST. If an IPN is passed in, validation of the IPN
 *     at PayPal will be bypassed.
 *
 * @return
 *   TRUE or FALSE indicating whether the IPN was successfully processed or not.
 */
function commerce_postfinance_process_ipn($subUri = NULL, $debug_ipn = array()) {
  // Retrieve the IPN from $_POST if the caller did not supply an IPN array.
  if (empty($debug_ipn)) {
    $ipn = $_POST;
  }
  else {
    $ipn = $debug_ipn;
  }

  // Give the payment method module an opportunity to validate the receiver
  // e-mail address and amount of the payment if possible. If a validate
  // function exists, it is responsible for setting its own watchdog message.
  if (!empty($ipn)) {

$orderid = $ipn['orderID'];

$payment_method = commerce_payment_method_instance_load('epayment_postfinance|commerce_payment_epayment_postfinance');
$settings = $payment_method['settings'];

$shaDigest = '';
$shaKey = $settings['reply_security_key'];
if(commerce_postfinance_security($shaKey,$settings['payment_security'])){
  $shaDigest = commerce_postfinance_shaDigest($ipn,$settings,'IN');
}

    if ($ipn['SHASIGN'] == $shaDigest) {
      // update order ..
      watchdog('commerce_postfinance', 'received Callback for @oid', array('@oid' => $orderid),WATCHDOG_INFO);
      $oid = substr($orderid, strlen($settings['order_prefix']));
      $order = commerce_order_load($oid);
      $status = 'processing';
      watchdog('commerce_postfinance', 'suburi @oid', array('@oid' => $subUri),WATCHDOG_INFO);
      if(!empty($subUri)){
	switch ($subUri[0]) {
	  case 'ok':
	    $status = 'completed';
	    break;
	  case 'fail':
	    $status = 'canceled';
	    break;
	}  
      }
		watchdog('commerce_epayment', 'status > @name: @val', array('@name' => $status, '@val' => $subUri),WATCHDOG_DEBUG);
      //commerce_order_status_update($order, $status, FALSE);
      return TRUE;
    } else {
	 watchdog('commerce_postfinance', 'IPN callback with wrong sign: Order @oid not updated - calculated digest @dig', array('@oid'=> $orderid, '@dig' => $shaDigest),WATCHDOG_WARNING);

    foreach ($ipn as $name => $value) {
	    watchdog('commerce_epayment', 'received > @name: @val', array('@name' => $name, '@val' => $value),WATCHDOG_DEBUG);
      }
	return FALSE;
    }
  }


}


/**
 * Returns the URL to the specified Postfinance server.
 *
 * @param $server
 *   Either test or prod indicating which server to get the URL for.
 *
 * @return
 *   The URL to use to submit requests to the PayPal WPS server.
 */
function commerce_postfinance_server_url($server, $encoding) {
  switch ($encoding) {
    case 'iso':
      return 'https://e-payment.postfinance.ch/ncol/'.$server.'/orderstandard.asp';
    case 'utf':
      return 'https://e-payment.postfinance.ch/ncol/'.$server.'/orderstandard_utf8.asp';
  }
}

function commerce_postfinance_buildadress($profileFormValues) {
  return trim($profileFormValues['thoroughfare'] .' '. $profileFormValues['premise'] . ' '. $profileFormValues['sub_premise']. ' '.$profileFormValues['dependent_locality']);
}

function commerce_postfinance_shaDigest($data, $settings, $shaAct) {

$shaDigest = '';
$shavalue = '';

$shaKey = $settings['payment_security_key'];
$shaParams = commerce_postfinance_shaOUTparams();
if($shaAct == 'IN'){
$shaKey = $settings['reply_security_key'];
$shaParams = commerce_postfinance_shaINparams();
}

// order alphabetically as specified
$data = array_flip($data);
natcasesort($data);
$data = array_flip($data);

  foreach ($data as $name => $value) {
    $nameU = strtoupper($name);
    if( strlen($value) > 0 && in_array($nameU, array_keys($shaParams))){
	$shavalue .= $nameU.'='.$value.$shaKey;
    }/*else{
watchdog('commerce_epayment', 'IGN > @name: @val', array('@name' => $name, '@val' => $value),WATCHDOG_DEBUG);
    }*/
  }

 $shaDigest = bin2hex(mhash(commerce_postfinance_security($shaKey,$settings['payment_security']),$shavalue));
/*watchdog('commerce_epayment', 'received > @name: @val', array('@name' => $shaDigest, '@val' => $shavalue),WATCHDOG_DEBUG);*/
return strtoupper($shaDigest);
}

function commerce_postfinance_security($key, $security) {
  if($key==''){return false;}
  switch ($security) {
    case 'none':
      return false;
    case 'sha1':
      return MHASH_SHA1;
    case 'sha256':
      return MHASH_SHA256;
    case 'sha512':
      return MHASH_SHA512;
  }
return false;
}

/**
 * Returns an array of all possible language codes.
 */
function commerce_postfinance_default_languages() {
  return drupal_map_assoc(array( 'de_DE', 'fr_FR', 'it_IT', 'es_ES', 'en_US'),'commerce_postfinance_transform_languages');
}
function commerce_postfinance_transform_languages($n){
return substr($n, -2);
}

/**
 * Returns an array of all possible currency codes.
 */
function commerce_postfinance_default_currencies() {
  return drupal_map_assoc(array('CHF','EUR'));
}

/**
 * Returns an array of all specified SHA-OUT Parameters.
 */
function commerce_postfinance_shaOUTparams(){
return drupal_map_assoc(array('ACCEPTURL','ADDMATCH','ADDRMATCH','AIAIRNAME','AIAIRTAX','AIBOOKIND*XX*','AICARRIER*XX*','AICHDET','AICLASS*XX*','AICONJTI','AIDESTCITY*XX*','AIDESTCITYL*XX*','AIEXTRAPASNAME*XX*','AIEYCD','AIFLDATE*XX*','AIFLNUM*XX*','AIIRST','AIORCITY*XX*','AIORCITYL*XX*','AIPASNAME','AISTOPOV*XX*','AITIDATE','AITINUM','AITYPCH','AIVATAMNT','AIVATAPPL','ALIAS','ALIASOPERATION','ALIASUSAGE','ALLOWCORRECTION','AMOUNT','AMOUNT*XX*','AMOUNTHTVA','AMOUNTTVA','BACKURL','BGCOLOR','BRAND','BRANDVISUAL','BUTTONBGCOLOR','BUTTONTXTCOLOR','CANCELURL','CARDNO','CATALOGURL','CAVV_3D','CAVVALGORITHM_3D','CERTID','CHECK_AAV','CIVILITY','CN','COM','COMPLUS','COSTCENTER','COSTCODE','CREDITCODE','CUID','CURRENCY','CVC','DATA','DATATYPE','DATEIN','DATEOUT','DECLINEURL','DISCOUNTRATE','ECI','ECOM_BILLTO_POSTAL_CITY','ECOM_BILLTO_POSTAL_COUNTRYCODE','ECOM_BILLTO_POSTAL_NAME_FIRST','ECOM_BILLTO_POSTAL_NAME_LAST','ECOM_BILLTO_POSTAL_POSTALCODE','ECOM_BILLTO_POSTAL_STREET_LINE1','ECOM_BILLTO_POSTAL_STREET_LINE2','ECOM_BILLTO_POSTAL_STREET_NUMBER','ECOM_CONSUMERID','ECOM_CONSUMERORDERID','ECOM_CONSUMERUSERALIAS','ECOM_PAYMENT_CARD_EXPDATE_MONTH','ECOM_PAYMENT_CARD_EXPDATE_YEAR','ECOM_PAYMENT_CARD_NAME','ECOM_PAYMENT_CARD_VERIFICATION','ECOM_SHIPTO_COMPANY','ECOM_SHIPTO_DOB','ECOM_SHIPTO_ONLINE_EMAIL','ECOM_SHIPTO_POSTAL_CITY','ECOM_SHIPTO_POSTAL_COUNTRYCODE','ECOM_SHIPTO_POSTAL_NAME_FIRST','ECOM_SHIPTO_POSTAL_NAME_LAST','ECOM_SHIPTO_POSTAL_POSTALCODE','ECOM_SHIPTO_POSTAL_STREET_LINE1','ECOM_SHIPTO_POSTAL_STREET_LINE2','ECOM_SHIPTO_POSTAL_STREET_NUMBER','ECOM_SHIPTO_TELECOM_FAX_NUMBER','ECOM_SHIPTO_TELECOM_PHONE_NUMBER','ECOM_SHIPTO_TVA','ED','EMAIL','EXCEPTIONURL','EXCLPMLIST','EXECUTIONDATE*XX*','FIRSTCALL','FLAG3D','FONTTYPE','FORCECODE1','FORCECODE2','FORCECODEHASH','FORCEPROCESS','FORCETP','GENERIC_BL','GIROPAY_ACCOUNT_NUMBER','GIROPAY_BLZ','GIROPAY_OWNER_NAME','GLOBORDERID','GUID','HDFONTTYPE','HDTBLBGCOLOR','HDTBLTXTCOLOR','HEIGHTFRAME','HOMEURL','HTTP_ACCEPT','HTTP_USER_AGENT','INCLUDE_BIN','INCLUDE_COUNTRIES','INVDATE','INVDISCOUNT','INVLEVEL','INVORDERID','ISSUERID','ITEMCATEGORY*XX*','ITEMDISCOUNT*XX*','ITEMID*XX*','ITEMNAME*XX*','ITEMPRICE*XX*','ITEMQUANT*XX*','ITEMUNITOFMEASURE*XX*','ITEMVATCODE*XX*','LANGUAGE','LEVEL1AUTHCPC','LIDEXCL*XX*','LIMITCLIENTSCRIPTUSAGE','LINE_REF','LIST_BIN','LIST_COUNTRIES','LOGO','MERCHANTID','MODE','MTIME','MVER','NETAMOUNT','OPERATION','ORDERID','ORIG','OR_INVORDERID','OR_ORDERID','OWNERADDRESS','OWNERADDRESS2','OWNERCTY','OWNERTELNO','OWNERTOWN','OWNERZIP','PAIDAMOUNT','PARAMPLUS','PARAMVAR','PAYID','PAYMETHOD','PM','PMLIST','PMLISTPMLISTTYPE','PMLISTTYPE','PMLISTTYPEPMLIST','PMTYPE','POPUP','POST','PSPID','PSWD','REF','REFER','REFID','REFKIND','REF_CUSTOMERID','REF_CUSTOMERREF','REMOTE_ADDR','REQGENFIELDS','RTIMEOUT','RTIMEOUTREQUESTEDTIMEOUT','SCORINGCLIENT','SETT_BATCH','SID','STATUS_3D','SUBSCRIPTION_ID','SUB_AM','SUB_AMOUNT','SUB_COM','SUB_COMMENT','SUB_CUR','SUB_ENDDATE','SUB_ORDERID','SUB_PERIOD_MOMENT','SUB_PERIOD_MOMENT_M','SUB_PERIOD_MOMENT_WW','SUB_PERIOD_NUMBER','SUB_PERIOD_NUMBER_D','SUB_PERIOD_NUMBER_M','SUB_PERIOD_NUMBER_WW','SUB_PERIOD_UNIT','SUB_STARTDATE','SUB_STATUS','TAAL','TAXINCLUDED*XX*','TBLBGCOLOR','TBLTXTCOLOR','TID','TITLE','TOTALAMOUNT','TP','TRACK2','TXTBADDR2','TXTCOLOR','TXTOKEN','TXTOKENTXTOKENPAYPAL','TYPE_COUNTRY','UCAF_AUTHENTICATION_DATA','UCAF_PAYMENT_CARD_CVC2','UCAF_PAYMENT_CARD_EXPDATE_MONTH','UCAF_PAYMENT_CARD_EXPDATE_YEAR','UCAF_PAYMENT_CARD_NUMBER','USERID','USERTYPE','VERSION','WBTU_MSISDN','WBTU_ORDERID','WEIGHTUNIT','WIN3DS','WITHROOT'));
}

/**
 * Returns an array of all specified SHA-IN Parameters.
 */
function commerce_postfinance_shaINparams(){
return drupal_map_assoc(array('AAVADDRESS', 'AAVCHECK', 'AAVZIP', 'ACCEPTANCE', 'ALIAS', 'AMOUNT', 'BRAND', 'CARDNO', 'CCCTY', 'CN', 'COMPLUS', 'CREATION_STATUS', 'CURRENCY', 'CVCCHECK', 'DCC_COMMPERCENTAGE', 'DCC_CONVAMOUNT', 'DCC_CONVCCY', 'DCC_EXCHRATE', 'DCC_EXCHRATESOURCE', 'DCC_EXCHRATETS', 'DCC_INDICATOR', 'DCC_MARGINPERCENTAGE', 'DCC_VALIDHOURS', 'DIGESTCARDNO', 'ECI', 'ED', 'ENCCARDNO', 'IP', 'IPCTY', 'NBREMAILUSAGE', 'NBRIPUSAGE', 'NBRIPUSAGE_ALLTX', 'NBRUSAGE', 'NCERROR', 'ORDERID', 'PAYID', 'PM', 'SCO_CATEGORY', 'SCORING', 'STATUS', 'SUBSCRIPTION_ID', 'TRXDATE', 'VC'));
}
